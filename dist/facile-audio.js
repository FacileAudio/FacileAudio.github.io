!function(t){function e(i){if(r[i])return r[i].exports;var n=r[i]={exports:{},id:i,loaded:!1};return t[i].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var r={};return e.m=t,e.c=r,e.p="/dist/",e(0)}([function(t,e,r){(function(t){"use strict";t.facile={Tx:r(5),Rx:r(4)}}).call(e,function(){return this}())},function(t,e){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(t){return"function"==typeof t}function n(t){return"number"==typeof t}function s(t){return"object"==typeof t&&null!==t}function o(t){return void 0===t}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(t){if(!n(t)||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},r.prototype.emit=function(t){var e,r,n,a,u,h;if(this._events||(this._events={}),"error"===t&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(e=arguments[1],e instanceof Error)throw e;var f=new Error('Uncaught, unspecified "error" event. ('+e+")");throw f.context=e,f}if(r=this._events[t],o(r))return!1;if(i(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),r.apply(this,a)}else if(s(r))for(a=Array.prototype.slice.call(arguments,1),h=r.slice(),n=h.length,u=0;u<n;u++)h[u].apply(this,a);return!0},r.prototype.addListener=function(t,e){var n;if(!i(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,i(e.listener)?e.listener:e),this._events[t]?s(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,s(this._events[t])&&!this._events[t].warned&&(n=o(this._maxListeners)?r.defaultMaxListeners:this._maxListeners,n&&n>0&&this._events[t].length>n&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace())),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(t,e){function r(){this.removeListener(t,r),n||(n=!0,e.apply(this,arguments))}if(!i(e))throw TypeError("listener must be a function");var n=!1;return r.listener=e,this.on(t,r),this},r.prototype.removeListener=function(t,e){var r,n,o,a;if(!i(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(r=this._events[t],o=r.length,n=-1,r===e||i(r.listener)&&r.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(s(r)){for(a=o;a-- >0;)if(r[a]===e||r[a].listener&&r[a].listener===e){n=a;break}if(n<0)return this;1===r.length?(r.length=0,delete this._events[t]):r.splice(n,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},r.prototype.removeAllListeners=function(t){var e,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[t],i(r))this.removeListener(t,r);else if(r)for(;r.length;)this.removeListener(t,r[r.length-1]);return delete this._events[t],this},r.prototype.listeners=function(t){var e;return e=this._events&&this._events[t]?i(this._events[t])?[this._events[t]]:this._events[t].slice():[]},r.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(i(e))return 1;if(e)return e.length}return 0},r.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e){var r=window.URL||window.webkitURL;t.exports=function(t,e){try{try{var i;try{var n=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;i=new n,i.append(t),i=i.getBlob()}catch(e){i=new Blob([t])}return new Worker(r.createObjectURL(i))}catch(e){return new Worker("data:application/javascript,"+encodeURIComponent(t))}}catch(t){return new Worker(e)}}},function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),n=function(){function t(e,i){r(this,t),this.space=e,this.data=new Float32Array(this.space),this.free=this.space,this.used=0,this.rpos=0,this.wpos=0,this.overruns=0,this.underruns=0,this.bufLen=i}return i(t,[{key:"write",value:function(t){this.free<t.length&&(++this.overruns,console.log("AudioBuffer: overrun"),this.read(t.length-this.free));var e=this.space-this.wpos;return e>=t.length?(this.data.set(t,this.wpos),this.wpos+=t.length):(this.data.set(t.subarray(0,e),this.wpos),this.data.set(t.subarray(e)),this.wpos=t.length-e),this.free-=t.length,this.used+=t.length,0}},{key:"read",value:function(t){if(this.used<this.bufLen)return++this.underruns,console.log("AudioBuffer: underrun "+this.used),null;var e=new Float32Array(t),r=this.space-this.rpos;return r>=t?(e.set(this.data.subarray(this.rpos,this.rpos+t)),this.rpos+=t):(e.set(this.data.subarray(this.rpos)),e.set(this.data.subarray(0,t-r),r),this.rpos=t-r),this.free+=t,this.used-=t,e}}]),t}();t.exports=n},function(t,e,r){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),u=r(1),h=r(3),f=function(t){function e(t,r){i(this,e);var s=n(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));if(s.audioCtx=null,s.procNode=null,s.worker=null,s.nsamples=2048,s.buffer=null,s.started=!1,s.events=["error","connect","disconnect","eot"],s.bufferMax=192e3,s.bufferMin=4*s.nsamples,s.server="https://rx.facile.audio/rx","string"!=typeof t)throw new Error("valid channel id is required");return s.channel=t,r&&"object"===("undefined"==typeof r?"undefined":o(r))&&(s.server=r.server||s.server),s._init(),s}return s(e,t),a(e,[{key:"_init",value:function(t){var e=window.AudioContext||window.webkitAudioContext;if(!e)throw new Error("unsupported");this.audioCtx=new e,console.log(this.audioCtx),this.buffer=new h(this.bufferMax,this.bufferMin)}},{key:"start",value:function(){var t=this;return this.started!==!1?Promise.reject(new Error("receiver is already running")):(this.procNode=this.audioCtx.createScriptProcessor(this.nsamples,2,2),this.procNode.onaudioprocess=function(e){t._audioProcess(e)},this.procNode.connect(this.audioCtx.destination),this._startWorker())}},{key:"_audioProcess",value:function(t){if(null!==this.worker){var e=t.outputBuffer.getChannelData(0),r=t.outputBuffer.getChannelData(1),i=this.buffer.read(2*this.nsamples),n=0,s=0;if(i)for(n=0;n<2*this.nsamples;n+=2)e[s]=i[n],r[s]=i[n+1],++s;else for(n=0;n<this.nsamples;++n)e[n]=0,r[n]=0}}},{key:"_startWorker",value:function(){var t=this;return new Promise(function(e,i){var n=r(6),s=new n;s.onmessage=function(r){return r.data instanceof Float32Array?t.buffer.write(r.data):void("init"===r.data.type?(console.log("ReceiverWorker initialized"),t.worker=s,t.started=!0,e()):"eot"===r.data.type?t.emit("eot"):"connect"===r.data.type?t.emit("connect"):"disconnect"===r.data.type?t.emit("disconnect"):"error"===r.data.type&&t.emit("error",r.data.err))},s.onerror=function(e){t.emit("error",e)},s.postMessage({setup:{sampleRate:t.audioCtx.sampleRate,nsamples:t.nsamples,channels:2,server:t.server,channel:t.channel}})})}},{key:"stop",value:function(){this.started===!0&&(this.procNode.disconnect(this.audioCtx.destination),this.procNode.onaudioprocess=null,this.worker&&(this.worker.terminate(),this.worker=null),this.started=!1)}},{key:"destroy",value:function(){var t=this;this.stop(),this.events.forEach(function(e){t.removeAllListeners(e)})}}]),e}(u);t.exports=f},function(t,e,r){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function o(t){if("string"!=typeof t)return 96e3;switch(t){case"worst":return 32e3;case"low":return 64e3;case"medium":return 96e3;case"high":return 128e3;case"best":return 192e3;default:return 96e3}}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),h=r(1),f=function(t){function e(t){i(this,e);var r=n(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return r.audioCtx=null,r.mediaStream=null,r.srcNode=null,r.procNode=null,r.muteNode=null,r.worker=null,r.initialized=!1,r.started=!1,r.events=["error","connect","disconnect"],r.quality="medium",r.server="https://tx.facile.audio/tx",r.nsamples=2048,r.frameSize=1920,t&&"object"===("undefined"==typeof t?"undefined":a(t))&&(r.server=t.server||r.server,r.quality=t.quality||r.quality),r}return s(e,t),u(e,[{key:"_capture",value:function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}):(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?new Promise(function(t,e){navigator.getUserMedia({audio:!0,video:!1},function(e){t(e)},function(t){e(t)})}):Promise.reject(new Error("unsupported")))}},{key:"_initAudio",value:function(){var t=this,e=window.AudioContext||window.webkitAudioContext;return e?(this.audioCtx=new e,this._capture().then(function(e){if(t.mediaStream=e,t.srcNode=t.audioCtx.createMediaStreamSource(e),2!==t.srcNode.channelCount)throw"Source: input is not stereo!"})):Promise.reject(new Error("unsupported"))}},{key:"_audioProcess",value:function(t){var e=t.inputBuffer.getChannelData(0),r=t.inputBuffer.getChannelData(1),i=new Float32Array(this.srcNode.channelCount*this.nsamples),n=0,s=0;for(n=0;n<this.nsamples;++n)i[s++]=e[n],i[s++]=r[n];this.worker&&this.worker.postMessage(i,[i.buffer])}},{key:"start",value:function(){var t=this;return this.started!==!1?Promise.reject(new Error("receiver is running")):this._initAudio().then(function(){return t.initialized=!0,t.procNode=t.audioCtx.createScriptProcessor(t.nsamples,t.srcNode.channelCount,2),t.srcNode.connect(t.procNode),t.procNode.onaudioprocess=function(e){t._audioProcess(e)},t.muteNode=t.audioCtx.createGain(),t.muteNode.gain.value=0,t.procNode.connect(t.muteNode),t.muteNode.connect(t.audioCtx.destination),t._startWorker()})}},{key:"_startWorker",value:function(){var t=this;return new Promise(function(e,i){var n=r(7),s=new n;s.onmessage=function(r){r.data.channel?(console.log("Trasmitter Worker initialized"),s.postMessage({ctl:{req:"OPUS_SET_BITRATE",val:o(t.quality)}}),t.worker=s,t.started=!0,e(r.data.channel)):"connect"===r.data.type?t.emit("connect"):"disconnect"===r.data.type?t.emit("disconnect",r.data.msg):"error"===r.data.type&&t.emit("error",r.data.err)},s.onerror=function(e){t.emit("error",e)},s.postMessage({setup:{sampleRate:t.audioCtx.sampleRate,nsamples:t.nsamples,frameSize:t.frameSize,channels:t.srcNode.channelCount,server:t.server}})})}},{key:"stop",value:function(){this.initialized===!0&&(this.srcNode.disconnect(this.procNode),this.procNode.disconnect(this.muteNode),this.muteNode.disconnect(this.audioCtx.destination),this.mediaStream.getTracks()[0].stop(),this.initialized=!1,this.started===!0&&(this.worker&&(this.worker.terminate(),this.worker=null),this.started=!1))}},{key:"destroy",value:function(){var t=this;this.stop(),this.events.forEach(function(e){t.removeAllListeners(e)})}}]),e}(h);t.exports=f},function(t,e,r){t.exports=function(){return r(2)('!function(t){function e(i){if(r[i])return r[i].exports;var s=r[i]={exports:{},id:i,loaded:!1};return t[i].call(s.exports,s,s.exports,e),s.loaded=!0,s.exports}var r={};return e.m=t,e.c=r,e.p="/dist/",e(0)}([function(t,e,r){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var s=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),o=r(3),n=r(2),a=r(1),u=null,f=function(){function t(){i(this,t),this.decoder=null,this.resampler=null,this.rx=null,this.sampleRate=48e3}return s(t,[{key:"error",value:function(t){postMessage({type:"error",err:"ReceiverWorker: "+t})}},{key:"init",value:function(t){var e=this,r="https://facile.audio/dist/socket.io-1.4.5.js";o.loadScript(r).then(function(r){importScripts(r),e._initIO(t)}).catch(function(t){postMessage({type:"error",err:t.message})})}},{key:"process",value:function(t){for(var e=null,r=0;r<t.length;++r){try{e=this.decoder.decode(t[r])}catch(t){console.log(t);continue}if(e.length!==this.config.frameSize*this.config.channels){this.error("Wrong number of samples! "+e.length);break}this.resampler?(this.resampler.initializeBuffers(),e=this.resampler.resample(e,e.length)):e=new Float32Array(e),postMessage(e,[e.buffer])}}},{key:"_initIO",value:function(t){var e=this,r=io(t.server);r.on("connect",function(){e.rx=r,r.emit("channel",t.channel),postMessage({type:"connect"})}),r.on("audio",function(t){e.process(t)}),r.on("eot",function(){postMessage({type:"eot"})}),r.on("config",function(r){e.config=r,t.sampleRate!==e.sampleRate&&(console.log("ReceiverWorker: need to resample 48000 --> "+t.sampleRate),e.resampler=new n(e.sampleRate,t.sampleRate,r.channels,Math.ceil(r.frameSize*r.channels*t.sampleRate/e.sampleRate),0));try{e.decoder=new a(e.sampleRate,r.channels,r.frameSize)}catch(t){return console.log(t),e.error(t)}postMessage({type:"init"})}),r.on("disconnect",function(){postMessage({type:"disconnect"})}),r.on("err",function(t){postMessage({type:"error",err:t})})}}]),t}();self.onmessage=function(t){if(t.data.setup){if(console.log("ReceiverWorker: initializing.."),null!==u)return void u.error("already initialized");var e="https://facile.audio/dist/libopus_dec.js";o.loadScript(e).then(function(e){importScripts(e),u=new f,u.init(t.data.setup)}).catch(function(t){postMessage({type:"error",err:t.message})})}else{if(null===u)return void postMessage({type:"error",err:"ReceiverWorker: not initialized"});u.error("invalid message")}}},function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),s=function(){function t(e,i,s){if(r(this,t),48e3!==e)throw"OpusDec: wrong rate "+e;this.rate=e,this.channels=i,this.frameSize=s,this.ctx=null,this.coded_ptr=null,this.raw_ptr=null;var o=4096,n=16384,a=_malloc(4);this.ctx=_opus_decoder_create(e,i,a);var u=getValue(a,"i32");if(0!==u)throw"OpusDec: opus_decoder_create failed: "+u;_free(a),this.coded_ptr=_malloc(o),this.coded=HEAPU8.subarray(this.coded_ptr,this.coded_ptr+o),this.raw_ptr=_malloc(n),this.raw=HEAPF32.subarray(this.raw_ptr>>2,this.raw_ptr+n>>2)}return i(t,[{key:"decode",value:function(t){this.coded.set(new Uint8Array(t));var e=_opus_decode_float(this.ctx,this.coded_ptr,t.byteLength,this.raw_ptr,this.raw.byteLength,0);if(e<0)throw"OpusDec: opus_decode failed: "+e;var r=this.raw.subarray(0,e*this.channels);return r}},{key:"destroy",value:function(){this.ctx&&(_opus_decoder_destroy(this.ctx),_free(this.coded_ptr),_free(this.raw_ptr),this.ctx=null,this.coded_ptr=null,this.raw_ptr=null)}}]),t}();t.exports=s},function(t,e){"use strict";function r(t,e,r,i,s){this.fromSampleRate=t,this.toSampleRate=e,this.channels=0|r,this.outputBufferSize=i,this.noReturn=!!s,this.initialize()}r.prototype.initialize=function(){if(!(this.fromSampleRate>0&&this.toSampleRate>0&&this.channels>0))throw new Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resample=this.bypassResampler,this.ratioWeight=1):(this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.fromSampleRate<this.toSampleRate?(this.compileLinearInterpolationFunction(),this.lastWeight=1):(this.compileMultiTapFunction(),this.tailExists=!1,this.lastWeight=0),this.initializeBuffers())},r.prototype.compileLinearInterpolationFunction=function(){var t=void 0,e="var bufferLength = Math.min(buffer.length, upTo);\\t  var outLength = this.outputBufferSize;\\t  if ((bufferLength % "+this.channels+") == 0) {\\t    if (bufferLength > 0) {\\t      var weight = this.lastWeight;\\t      var firstWeight = 0;\\t      var secondWeight = 0;\\t      var sourceOffset = 0;\\t      var outputOffset = 0;\\t      var outputBuffer = this.outputBuffer;\\t      for (; weight < 1; weight += "+this.ratioWeight+") {\\t        secondWeight = weight % 1;\\t        firstWeight = 1 - secondWeight;";for(t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = (this.lastOutput["+t+"] * firstWeight) + (buffer["+t+"] * secondWeight);";for(e+="}\\t      weight -= 1;\\t      for (bufferLength -= "+this.channels+", sourceOffset = Math.floor(weight) * "+this.channels+"; outputOffset < outLength && sourceOffset < bufferLength;) {\\t        secondWeight = weight % 1;\\t        firstWeight = 1 - secondWeight;",t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = (buffer[sourceOffset"+(t>0?" + "+t:"")+"] * firstWeight) + (buffer[sourceOffset + "+(this.channels+t)+"] * secondWeight);";for(e+="weight += "+this.ratioWeight+";\\t        sourceOffset = Math.floor(weight) * "+this.channels+";\\t      }",t=0;t<this.channels;++t)e+="this.lastOutput["+t+"] = buffer[sourceOffset++];";e+=\'this.lastWeight = weight % 1;\\t      return this.bufferSlice(outputOffset);\\t    }\\t    else {\\t      return (this.noReturn) ? 0 : [];\\t    }\\t  }\\t  else {\\t    throw(new Error("Buffer was of incorrect sample length."));\\t  }\',this.resample=Function("buffer","upTo",e)},r.prototype.compileMultiTapFunction=function(){var t=void 0,e="var bufferLength = Math.min(buffer.length, upTo);\\t  var outLength = this.outputBufferSize;\\t  if ((bufferLength % "+this.channels+") == 0) {\\t    if (bufferLength > 0) {\\t      var weight = 0;";for(t=0;t<this.channels;++t)e+="var output"+t+" = 0;";for(e+="var actualPosition = 0;\\t      var amountToNext = 0;\\t      var alreadyProcessedTail = !this.tailExists;\\t      this.tailExists = false;\\t      var outputBuffer = this.outputBuffer;\\t      var outputOffset = 0;\\t      var currentPosition = 0;\\t      do {\\t        if (alreadyProcessedTail) {\\t          weight = "+this.ratioWeight+";",t=0;t<this.channels;++t)e+="output"+t+" = 0;";for(e+="}\\t        else {\\t          weight = this.lastWeight;",t=0;t<this.channels;++t)e+="output"+t+" = this.lastOutput["+t+"];";for(e+="alreadyProcessedTail = true;\\t        }\\t        while (weight > 0 && actualPosition < bufferLength) {\\t          amountToNext = 1 + actualPosition - currentPosition;\\t          if (weight >= amountToNext) {",t=0;t<this.channels;++t)e+="output"+t+" += buffer[actualPosition++] * amountToNext;";for(e+="currentPosition = actualPosition;\\t            weight -= amountToNext;\\t          }\\t          else {",t=0;t<this.channels;++t)e+="output"+t+" += buffer[actualPosition"+(t>0?" + "+t:"")+"] * weight;";for(e+="currentPosition += weight;\\t            weight = 0;\\t            break;\\t          }\\t        }\\t        if (weight <= 0) {",t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = output"+t+" / "+this.ratioWeight+";";for(e+="}\\t        else {\\t          this.lastWeight = weight;",t=0;t<this.channels;++t)e+="this.lastOutput["+t+"] = output"+t+";";e+=\'this.tailExists = true;\\t          break;\\t        }\\t      } while (actualPosition < bufferLength && outputOffset < outLength);\\t      return this.bufferSlice(outputOffset);\\t    }\\t    else {\\t      return (this.noReturn) ? 0 : [];\\t    }\\t  }\\t  else {\\t    throw(new Error("Buffer was of incorrect sample length."));\\t  }\',this.resample=Function("buffer","upTo",e)},r.prototype.bypassResampler=function(t,e){return this.outputBuffer=t,this.bufferSlice(e)},r.prototype.bufferSlice=function(t){if(this.noReturn)return t;try{return this.outputBuffer.subarray(0,t)}catch(e){try{return this.outputBuffer.length=t,this.outputBuffer}catch(e){return this.outputBuffer.slice(0,t)}}},r.prototype.initializeBuffers=function(){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(t){this.outputBuffer=[],this.lastOutput=[]}},t.exports=r},function(t,e){"use strict";function r(t){return new Promise(function(e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(){var t=i.response,r=URL.createObjectURL(t);e(r)},i.onerror=function(t){r(t)},i.send()})}t.exports={loadScript:r}}]);\n//# sourceMappingURL=b0464bf8aaadce4d03ca.worker.js.map',r.p+"b0464bf8aaadce4d03ca.worker.js")}},function(t,e,r){t.exports=function(){return r(2)('!function(t){function e(i){if(r[i])return r[i].exports;var s=r[i]={exports:{},id:i,loaded:!1};return t[i].call(s.exports,s,s.exports,e),s.loaded=!0,s.exports}var r={};return e.m=t,e.c=r,e.p="/dist/",e(0)}([function(t,e,r){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var s=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),n=r(3),o=r(2),a=r(1),u=null,h=function(){function t(){i(this,t),this.encoder=null,this.resampler=null,this.tx=null}return s(t,[{key:"init",value:function(t){var e=this;if(isNaN(t.sampleRate))throw"Transmitter Worker: invalid rate "+t.sampleRate;if(2!==t.channels)throw"Transmitter Worker: invalid channel count "+t.channels;if(isNaN(t.nsamples))throw"Transmitter Worker: invalid samples count "+t.nsamples;if(isNaN(t.frameSize))throw"Transmitter Worker: invalid frame size "+t.frameSize;if("string"!=typeof t.server)throw"Transmitter Worker: invalid server "+t.server;48e3!==t.sampleRate&&(console.log("Transmitter Worker: need to resample "+t.sampleRate+" ---> 48000"),this.resampler=new o(t.sampleRate,48e3,t.channels,Math.ceil(t.nsamples*t.channels*48e3/t.sampleRate),0));try{this.encoder=new a(48e3,t.channels,t.frameSize)}catch(t){this.error(t)}var r="https://facile.audio/dist/socket.io-1.4.5.js";n.loadScript(r).then(function(r){importScripts(r),e._initIO(t)}).catch(function(t){postMessage({type:"error",err:t.message})})}},{key:"process",value:function(t){var e=null;this.resampler&&(t=this.resampler.resample(t,t.length));try{e=this.encoder.encode(t)}catch(t){return void u.error(t)}this.tx&&this.tx.compress(!1).emit("audio",e)}},{key:"error",value:function(t){postMessage({type:"error",err:"Transmitter Worker: "+t})}},{key:"_initIO",value:function(t){var e=this,r=io(t.server);r.on("connect",function(){e.tx=r,postMessage({type:"connect"}),r.emit("config",{sampleRate:t.sampleRate,frameSize:t.frameSize,channels:t.channels})}),r.on("channel",function(t){postMessage({channel:t})}),r.on("disconnect",function(t){postMessage({type:"disconnect"})}),r.on("err",function(t){postMessage({type:"error",err:t})})}}]),t}();self.onmessage=function(t){if(t.data instanceof Float32Array)null!==u?u.process(t.data):postMessage({type:"error",err:"Transmitter Worker: not initialized"});else if(t.data.setup){if(console.log("Transmitter Worker: initializing.."),null!==u)return void u.error("Transmitter Worker: already initialized");var e="https://facile.audio/dist/libopus_enc.js";n.loadScript(e).then(function(e){importScripts(e),u=new h,u.init(t.data.setup)}).catch(function(t){postMessage({type:"error",err:t.message})})}else if(t.data.ctl)if(null!==u)try{u.encoder.ctl(t.data.ctl.req,t.data.ctl.val)}catch(t){u.error(t)}else postMessage({type:"error",err:"Transmitter Worker: not initialized"});else{if(null===u)return void postMessage({type:"error",err:"Transmitter Worker: not initialized"});u.error("Transmitter Worker: invalid message")}}},function(t,e){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),s=function(){function t(e,i,s){if(r(this,t),48e3!==e)throw"OpusEnc: wrong rate "+e;this.rate=e,this.channels=i,this.frameSize=s;var n=_malloc(4);this.ctx=_opus_encoder_create(this.rate,this.channels,2049,o);var o=getValue(n,"i32");if(0!==o)throw"OpusEnc: opus_encoder_create failed: "+o;_free(n),this.raw_ptr=_malloc(this.frameSize*this.channels*4),this.raw_len=this.frameSize*this.channels,this.raw=HEAPF32.subarray(this.raw_ptr>>2,(this.raw_ptr>>2)+this.raw_len);var a=4096;this.coded_sz=a,this.coded_ptr=_malloc(this.coded_sz),this.coded=HEAPU8.subarray(this.coded_ptr,this.coded_ptr+this.coded_sz),this.raw_off=0}return i(t,[{key:"encode",value:function(t){for(var e=[],r=0;t.length-r>=this.raw_len-this.raw_off;){this.raw_off>0?(this.raw.set(t.subarray(r,r+this.raw_len-this.raw_off),this.raw_off),r+=this.raw_len-this.raw_off,this.raw_off=0):(this.raw.set(t.subarray(r,r+this.raw_len)),r+=this.raw_len);var i=_opus_encode_float(this.ctx,this.raw_ptr,this.frameSize,this.coded_ptr,this.coded_sz);if(i<=0)throw"OpusEnc: opus_encode_float failed: "+i;var s=new ArrayBuffer(i);new Uint8Array(s).set(this.coded.subarray(0,i)),e.push(s)}return r<t.length&&(this.raw.set(t.subarray(r)),this.raw_off=t.length-r),e}},{key:"ctl",value:function(t,e){if("OPUS_SET_BITRATE"===t){if(isNaN(e))throw"OpusEnc: NaN value "+e;if(e<500||e>512e3)throw"OpusEnc: invalid value "+e;var r=_malloc(4);setValue(r,e,"i32");var i=_opus_encoder_ctl(this.ctx,4002,r);if(i<0)throw"OpusEnc: opus_encoder_ctl failed: "+i;return void _free(r)}throw"OpusEnc: invalid control "+t}},{key:"destroy",value:function(){this.ctx&&(_opus_encoder_destroy(this.ctx),_free(this.raw_ptr),_free(this.coded_ptr),this.ctx=null,this.coded_ptr=null,this.raw_ptr=null)}}]),t}();t.exports=s},function(t,e){"use strict";function r(t,e,r,i,s){this.fromSampleRate=t,this.toSampleRate=e,this.channels=0|r,this.outputBufferSize=i,this.noReturn=!!s,this.initialize()}r.prototype.initialize=function(){if(!(this.fromSampleRate>0&&this.toSampleRate>0&&this.channels>0))throw new Error("Invalid settings specified for the resampler.");this.fromSampleRate==this.toSampleRate?(this.resample=this.bypassResampler,this.ratioWeight=1):(this.ratioWeight=this.fromSampleRate/this.toSampleRate,this.fromSampleRate<this.toSampleRate?(this.compileLinearInterpolationFunction(),this.lastWeight=1):(this.compileMultiTapFunction(),this.tailExists=!1,this.lastWeight=0),this.initializeBuffers())},r.prototype.compileLinearInterpolationFunction=function(){var t=void 0,e="var bufferLength = Math.min(buffer.length, upTo);\\t  var outLength = this.outputBufferSize;\\t  if ((bufferLength % "+this.channels+") == 0) {\\t    if (bufferLength > 0) {\\t      var weight = this.lastWeight;\\t      var firstWeight = 0;\\t      var secondWeight = 0;\\t      var sourceOffset = 0;\\t      var outputOffset = 0;\\t      var outputBuffer = this.outputBuffer;\\t      for (; weight < 1; weight += "+this.ratioWeight+") {\\t        secondWeight = weight % 1;\\t        firstWeight = 1 - secondWeight;";for(t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = (this.lastOutput["+t+"] * firstWeight) + (buffer["+t+"] * secondWeight);";for(e+="}\\t      weight -= 1;\\t      for (bufferLength -= "+this.channels+", sourceOffset = Math.floor(weight) * "+this.channels+"; outputOffset < outLength && sourceOffset < bufferLength;) {\\t        secondWeight = weight % 1;\\t        firstWeight = 1 - secondWeight;",t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = (buffer[sourceOffset"+(t>0?" + "+t:"")+"] * firstWeight) + (buffer[sourceOffset + "+(this.channels+t)+"] * secondWeight);";for(e+="weight += "+this.ratioWeight+";\\t        sourceOffset = Math.floor(weight) * "+this.channels+";\\t      }",t=0;t<this.channels;++t)e+="this.lastOutput["+t+"] = buffer[sourceOffset++];";e+=\'this.lastWeight = weight % 1;\\t      return this.bufferSlice(outputOffset);\\t    }\\t    else {\\t      return (this.noReturn) ? 0 : [];\\t    }\\t  }\\t  else {\\t    throw(new Error("Buffer was of incorrect sample length."));\\t  }\',this.resample=Function("buffer","upTo",e)},r.prototype.compileMultiTapFunction=function(){var t=void 0,e="var bufferLength = Math.min(buffer.length, upTo);\\t  var outLength = this.outputBufferSize;\\t  if ((bufferLength % "+this.channels+") == 0) {\\t    if (bufferLength > 0) {\\t      var weight = 0;";for(t=0;t<this.channels;++t)e+="var output"+t+" = 0;";for(e+="var actualPosition = 0;\\t      var amountToNext = 0;\\t      var alreadyProcessedTail = !this.tailExists;\\t      this.tailExists = false;\\t      var outputBuffer = this.outputBuffer;\\t      var outputOffset = 0;\\t      var currentPosition = 0;\\t      do {\\t        if (alreadyProcessedTail) {\\t          weight = "+this.ratioWeight+";",t=0;t<this.channels;++t)e+="output"+t+" = 0;";for(e+="}\\t        else {\\t          weight = this.lastWeight;",t=0;t<this.channels;++t)e+="output"+t+" = this.lastOutput["+t+"];";for(e+="alreadyProcessedTail = true;\\t        }\\t        while (weight > 0 && actualPosition < bufferLength) {\\t          amountToNext = 1 + actualPosition - currentPosition;\\t          if (weight >= amountToNext) {",t=0;t<this.channels;++t)e+="output"+t+" += buffer[actualPosition++] * amountToNext;";for(e+="currentPosition = actualPosition;\\t            weight -= amountToNext;\\t          }\\t          else {",t=0;t<this.channels;++t)e+="output"+t+" += buffer[actualPosition"+(t>0?" + "+t:"")+"] * weight;";for(e+="currentPosition += weight;\\t            weight = 0;\\t            break;\\t          }\\t        }\\t        if (weight <= 0) {",t=0;t<this.channels;++t)e+="outputBuffer[outputOffset++] = output"+t+" / "+this.ratioWeight+";";for(e+="}\\t        else {\\t          this.lastWeight = weight;",t=0;t<this.channels;++t)e+="this.lastOutput["+t+"] = output"+t+";";e+=\'this.tailExists = true;\\t          break;\\t        }\\t      } while (actualPosition < bufferLength && outputOffset < outLength);\\t      return this.bufferSlice(outputOffset);\\t    }\\t    else {\\t      return (this.noReturn) ? 0 : [];\\t    }\\t  }\\t  else {\\t    throw(new Error("Buffer was of incorrect sample length."));\\t  }\',this.resample=Function("buffer","upTo",e)},r.prototype.bypassResampler=function(t,e){return this.outputBuffer=t,this.bufferSlice(e)},r.prototype.bufferSlice=function(t){if(this.noReturn)return t;try{return this.outputBuffer.subarray(0,t)}catch(e){try{return this.outputBuffer.length=t,this.outputBuffer}catch(e){return this.outputBuffer.slice(0,t)}}},r.prototype.initializeBuffers=function(){try{this.outputBuffer=new Float32Array(this.outputBufferSize),this.lastOutput=new Float32Array(this.channels)}catch(t){this.outputBuffer=[],this.lastOutput=[]}},t.exports=r},function(t,e){"use strict";function r(t){return new Promise(function(e,r){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(){var t=i.response,r=URL.createObjectURL(t);e(r)},i.onerror=function(t){r(t)},i.send()})}t.exports={loadScript:r}}]);\n//# sourceMappingURL=f6763418363db4a3facf.worker.js.map',r.p+"f6763418363db4a3facf.worker.js");
}}]);
//# sourceMappingURL=facile-audio.js.map